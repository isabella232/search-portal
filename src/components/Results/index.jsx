import React, { useState, useEffect } from 'react';
import { withStyles } from '@material-ui/core/styles';
import Tabs from '@material-ui/core/Tabs';
import HoverTab from './HoverTab';
import Empty from './Empty';
import TabContent from './TabContent';

// Conversion table from tab ID to human-readable labels
const tooltipStyle = {
  textAlign: 'center',
};
const TAB_LABELS = {
  'enrichment': {
    label: 'Relevant Pathways',
    tooltip: (
      <div style={tooltipStyle}>
        Selected curated and experimentally derived pathways <br />
        (NCI-PID, Signor 2.0, etc.)
      </div>
    ),
  },
  'interactome-ppi': {
    label: 'Protein Interactions',
    tooltip: (
      <div style={tooltipStyle}>
        PPI networks from several sources (BioGRID, STRING, etc.)
      </div>
    ),
  },
  'interactome-association': {
    label: 'Gene Association',
    tooltip: (
      <div style={tooltipStyle}>
        Drug, disease and other gene-association networks <br />
        (CTD, HPA, etc.)
      </div>
    ),
  },
  'pathwayfigures': {
    label: 'Pathway Figures',
    tooltip: (
      <div style={tooltipStyle}>
        Node-only networks generated by optical recognition of published figures
        (courtesy of the WikiPathways team)
      </div>
    ),
  },
  'indra': {
    label: 'INDRA GO',
    tooltip: (
      <div style={tooltipStyle}>
        Collection of machine-curated pathways generated with the INDRA engine
        (courtesy of the Sorger Lab)
      </div>
    ),
  },
};

const backgroundcolor = 'rgb(235, 235, 235)';

const styles = (theme) => ({
  tabs: {},
  grow: {
    flexGrow: 1,
  },
});

const Results = (props) => {
  const { classes, ...others } = props;

  // For tab selection
  const [idx, setSelectedTabIndex] = useState(0);

  useEffect(() => {
    updateHistory(0);
  }, []);

  const handleChange = (event, idx) => {
    setSelectedTabIndex(idx);
    updateHistory(idx);
    props.networkActions.networkClear();
    props.networkActions.changeListIndex(0);
    if (idx === 3) {
      props.uiStateActions.setPathwayFigure(true);
    }
  };

  const updateHistory = (newValue) => {
    // Update URL
    const results = props.search.results;
    if (results === null || results === undefined) {
      return;
    }

    const jobId = results.jobId;
    const searchResults = props.search.searchResults;
    if (searchResults !== undefined && searchResults !== null) {
      const sourceName = getSourceName(sources, newValue);
      console.log('* Tab change:', jobId, sourceName);
      props.uiStateActions.setSelectedSource(sourceName);
      props.history.push(`/${jobId}/${sourceName}`);
    }
  };

  // Source list is not available.  Just return empty result
  const { sources } = props.source;
  if (sources === null || sources === undefined || sources.length === 0) {
    return <Empty />;
  }

  const searchResults = props.search.searchResults;
  const selectedSourceName = getSourceName(sources, idx);

  if (selectedSourceName == null) {
    return <Empty />;
  }

  const results = findResult(selectedSourceName, searchResults);

  // Get current tab selection
  return (
    <div className='results-container'>
      <div className='results-wrapper'>
        <Tabs value={idx} onChange={handleChange} className={classes.tabs}>
          {sources.map((source) => (
            <HoverTab
              key={source.uuid}
              label={
                TAB_LABELS[source.name] ? TAB_LABELS[source.name].label : null
              }
              tooltip={
                TAB_LABELS[source.name] ? TAB_LABELS[source.name].tooltip : null
              }
              backgroundcolor={backgroundcolor}
            />
          ))}
        </Tabs>

        {props.search.results.genes.size ? (
          <TabContent results={results} {...others} />
        ) : (
          <Empty
            message='No valid query genes.'
            details='Your query did not contain any valid gene names.'
          />
        )}
      </div>
    </div>
  );
};

const getSourceName = (sources, idx) => {
  if (sources[idx] == null) {
    return 'enrichment';
  }
  return sources[idx].name;
};

const findResult = (sourceName, results) => {
  if (results === null || results === undefined) {
    return null;
  }

  const resultArray = results.sources.filter((entry) => entry !== undefined);
  let idx = resultArray.length;

  while (idx--) {
    const currentResult = resultArray[idx];
    if (currentResult.sourceName === sourceName) {
      return currentResult;
    }
  }
  return null;
};

export default withStyles(styles)(Results);
